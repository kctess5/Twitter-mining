<!DOCTYPE html>
<html>
<head>
    <script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>

<style>

  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #container { width: 100%; height: 100% }
  #nav { z-index: 100; position: absolute; margin: 10px 0px 0px 200px; background-color: #fff; border: 1px #000 Solid; padding: 5px; }
  #map { width: 100%; height: 100% }

</style>

<script src="http://maps.google.com/maps/api/js?sensor=false&libraries=places" type="text/javascript"></script>
<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/maplabel/src/maplabel-compiled.js"></script>

<script>

function initialize() {

    var counter = 0;
    var markers = 50;
    window.marker = [];
    window.tweets = [];

    var commonWords = ["the","of","and","a","to","in","is","you","that","it","he","was","for","on","are","as","with","his","they","i","at","be","this","have","from","or","one","had","by","word","but","not","what","all","were","we","when","your","can","said","there","use","an","each","which","she","do","how","their","if","will","up","other","about","out","many","then","them","these","so","some","her","would","make","like","him","into","time","has","look","two","more","write","go","see","number","no","way","could","people","my","than","first","water","been","call","who","oil","its","now","find","long","down","day","did","get","come","made","may","part","im","me","[pic]", "", "que","de","no","a","la","el","es","y","en","lo","un","por","qué","me","una","te","los","se","con","para","mi","está","si","bien","pero","yo","eso","las","sí","su","tu","aquí","del","al","como","le","más","esto","ya","todo","esta","vamos","muy","rt","ka"];

    var socket = io.connect();

    var styles = [
        {
            featureType: 'landscape',
            elementType: 'all',
            stylers: [
                { hue: '#1188aa' },
                { saturation: 75 },
                { lightness: -59 },
                { visibility: 'simplified' }
            ]
        },{
            featureType: 'water',
            elementType: 'all',
            stylers: [
                { hue: '#222222' },
                { saturation: -100 },
                { lightness: -82 },
                { visibility: 'on' }
            ]
        },{
            featureType: 'road',
            elementType: 'all',
            stylers: [
                { hue: '#000000' },
                { saturation: -100 },
                { lightness: -100 },
                { visibility: 'off' }
            ]
        },{
            featureType: 'poi',
            elementType: 'all',
            stylers: [
                { hue: '#000000' },
                { saturation: -100 },
                { lightness: -100 },
                { visibility: 'off' }
            ]
        },{
            featureType: 'transit',
            elementType: 'all',
            stylers: [
                { hue: '#000000' },
                { saturation: 0 },
                { lightness: -100 },
                { visibility: 'off' }
            ]
        },{
            featureType: 'administrative',
            elementType: 'geometry',
            stylers: [
                { hue: '#000000' },
                { saturation: 0 },
                { lightness: -100 },
                { visibility: 'off' }
            ]
        },{
            featureType: 'administrative.locality',
            elementType: 'all',
            stylers: [
                { hue: '#000000' },
                { saturation: 0 },
                { lightness: 0 },
                { visibility: 'off' }
            ]
        }
    ];

    var mapOptions = {
        mapTypeControlOptions: {
            mapTypeIds: [ 'Styled']
        },
        center: new google.maps.LatLng(20,0),
        zoom: 2,
        mapTypeId: 'Styled'
    };

    var mapDiv = document.getElementById('map');

    window.map = new google.maps.Map(mapDiv, mapOptions);
    var styledMapType = new google.maps.StyledMapType(styles, { name: 'Styled' });
    window.map.mapTypes.set('Styled', styledMapType);

    google.maps.event.addListener(map, 'bounds_changed', function() {
        var bounds = window.map.getBounds();
        socket.emit('viewresize', { lat: {min:bounds.fa.b,max:bounds.fa.d}, lon: {min:bounds.ba.d,max:bounds.ba.b}  });
      });

    socket.on('stream', function(tweet){

        var myLatlng = new google.maps.LatLng(tweet.coordinates[1],tweet.coordinates[0]);
        window.tweets[counter%markers] = tweet.text;
        // console.log(counter%markers);
        // console.log(window.tweets[counter%markers]);

        var wordArray = [];

        for(var i = 0; i < window.tweets.length; i++){
          var words = cleanString( window.tweets[i] ).split(" ");
          wordArray = wordArray.concat( cleanWords(words) );
        }
        console.log(mode(wordArray));
        // console.log(wordArray);
        // console.log(tweet.text);


        // var marker = new google.maps.Marker({
        //     position: myLatlng
        // });

        // marker.setMap(map);

        // console.log(map.getZoom());
        // var mapLabel = new MapLabel({
        //    text: 'Test',
        //    position: myLatlng,
        //    map: map,
        //    fontSize: 12,
        //    strokeWeight:0,
        //    fontColor:'ffffff',
        //    align: 'right'
        //  });

        // mapLabel.set('position', myLatlng);

        // function placeMarker(location) {
          if (window.marker[counter%markers]) {
            //if marker already was created change positon
            window.marker[counter%markers].setPosition(myLatlng);
          } else {
            //create a marker
            window.marker[counter%markers] = new google.maps.Marker({
                position: myLatlng
            });

            window.marker[counter%markers].setMap(map);
          }
          counter += 1;
        // }

    });


function mode(array)
{
    if(array.length == 0)
      return null;
    var modeMap = {};
    var maxEl = array[0], maxCount = 1;
    for(var i = 0; i < array.length; i++)
    {
      var el = array[i];
      if(modeMap[el] == null)
        modeMap[el] = 1;
      else
        modeMap[el]++;  
      if(modeMap[el] > maxCount)
      {
        maxEl = el;
        maxCount = modeMap[el];
      }
    }
    return maxEl;
}

function cleanString(string){
  // string = String(string).toLowerCase();
  // var string = string.replace(/[^\w\s]/gi, '').replace( /[\s\n\r]+/g, ' ' );

  // var regex = XRegExp("[^\\s\\p{Latin}]+", "g");
  // // var str = "¿Me puedes decir la contraseña de la Wi-Fi?"
  // var string = XRegExp.replace(string, regex, "");

  return string;
}

function cleanWords(array){
  for(var i = 0; i < commonWords.length; i++){ 
    array = array.clean(commonWords[i]);
  }
  return array;
}

Array.prototype.clean = function(deleteValue) {
  for (var i = 0; i < this.length; i++) {
    if (this[i] == deleteValue) {         
      this.splice(i, 1);
      i--;
    }
  }
  return this;
};

};
</script>

</head>

<body onload="initialize();">

<div id="container">
    <div id="map"></div>
</div>


</body>
</html>
